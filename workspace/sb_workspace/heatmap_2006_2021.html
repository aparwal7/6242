<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Chicago New Permits Heatmap 2007 - 2021</title>
    <script type="text/javascript" src="./js/d3.v5.min.js"></script>
    <script type="text/javascript" src="./js/d3-tip.min.js"></script> 
    <script type="text/javascript" src="./js/linecharts.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/linecharts.css">
    <style>
    .d3-tip {
      line-height: 1;
      //font-weight: bold;
      padding: 12px;
      background: rgba(43,43,43, 0.8);
      color: #fff;
      border-radius: 2px;
    }      
    </style>
</head>
<body>
<div id="container-A" class="svg-container" style="position: absolute; left: 0px; top: 0px;">
</div>
<script>
//------------------------Useful functions -------------------------//
//var colorScheme = d3.scaleOrdinal(d3.schemeCategory10);
var colorScheme = d3.scaleOrdinal(d3.schemeTableau10);

const timeConv = d3.timeParse("%Y-%m");

function labelMaker (s) {return ("Ward " + s); };


// enter code to create color scale
// https://colorbrewer2.org/?type=sequential&scheme=Oranges&n=4
const brewedColors = ['#feedde','#fdbe85','#fd8d3c','#d94701'];


// Based on Density (number of permits for that month)
function colorForDensity (density) {
    /* Same color function as map */
    if ( density >= 15 ) fillColor = "#54278f";
    else if ( density >= 10 ) fillColor = "#756bb1";
    else if ( density >= 6 ) fillColor = "#9e9ac8";
    else if ( density >= 3 ) fillColor = "#bcbddc";
    else if ( density > 0 ) fillColor = "#dadaeb";
    else fillColor = "#f2f0f7";  // no data
    return fillColor;
};

// Compute quartile scale based on data (experimental)
function computeQuartiles (chosenData) {
  let quantileScale = d3.scaleQuantile()
          .domain(chosenData)
          .range(brewedColors);
  return quantileScale;
};

//----------------------------SCALES----------------------------//
const xTimeScale = d3.scaleTime().range([0,width]);
const yLinearScale = d3.scaleLinear().rangeRound([height, 0]);

const xScale = xTimeScale;
const yScale = yLinearScale;

//------------------ data

// set the dimensions and margins of the graph
var margin = {top: 30, right: 30, bottom: 30, left: 30},
              width = 800 - margin.left - margin.right,
              height = 450 - margin.top - margin.bottom;
const adj = 60;
const padding = 0;

// append the svg object to the body of the page
/***
var svg = d3.select("#container-A")
            .append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
***/

// we are appending SVG first
const svg = d3.select("#container-A").append("svg")
    .attr("width", 600)
    .attr("height", 300)
    .attr("preserveAspectRatio", "xMinYMin meet")
    .attr("viewBox", "-"
          + adj + " -"
          + adj + " "
          + (width + adj*3) + " "
          + (height + adj*3))
    .style("padding", padding)
    .style("margin", margin)
    .classed("svg-content", true);

//var myColor = d3.scaleLinear()
//  .range(["white", "#69b3a2"])
//  .domain([1,100])
// Build color scale
var heatColor = d3.scaleSequential()
    .interpolator(d3.interpolateInferno)
    .domain([1,100])


let dummy = [0, 1, 5, 23, 3, 35, 15, 1, 3, 0, 50];
var permitQuartiles = computeQuartiles(dummy);

function heatColorAsQuartiles (permits) {
  let show_color = 'grey';
  if (permits > 0) {
    show_color = permitQuartiles(permits);
  }
  return show_color;
};

//Read the data
d3.csv("new_permits_by_ward_month.csv").then( buildMyHeatMap );

function buildMyHeatMap (array_data) {

  let xDomain = d3.extent(array_data, function(d){return timeConv(d.month)});

  // Y - Wards: 1 to 50
  // let yDomain = [...new Set(array_data.map(item => +item.WARD))];
  let yDomain = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50,];


  // Build X scales and axis:
  var x = d3.scaleBand()
    .range([ 0, width ])
    .domain(xDomain)
    .padding(0.01);

  const xScale = d3.scaleTime().range([0,width]).domain(xDomain);

  const xaxis = d3.axisBottom()
        .ticks(d3.timeYear.every(2)) 
        .tickFormat(d3.timeFormat('%b %Y'))
        .scale(xScale);

  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(xaxis);

  // Build Y scales and axis:
  var y = d3.scaleBand()
      .range([ height, 0 ])
      .domain(yDomain)
      .padding(0.01);
  
  svg.append("g")
      .style("font-size", "8px")
      .call(d3.axisLeft(y));

  // TODO - make this work correct
  let y_center = height/2;
  svg.append("text")
     .attr("id", "y_axis_label")
     .attr("x", -padding).attr("y", y_center * 1.5)
     .attr("font-size", "12px")
     .attr("transform", "rotate(-90, -60, " + y_center * 1.5 + ")")
     .text("Chicago Ward #");

  // Include a second y axis on the far right
  svg.append("g")
    .style("font-size", "8px")
    .attr("transform", "translate(" + (width+5) + "," + 0 + ")")
    .call(d3.axisRight(y));

  svg.selectAll()
      .data(array_data, function(d) {return d.month+':'+d.WARD;})
      .enter()
      .append("rect")
      .attr("x", function(d) { return xScale(timeConv(d.month)); })
      .attr("y", function(d) { return y(d.WARD); })
      //.attr("width", x.bandwidth() )
      //.attr("height", y.bandwidth() )
      .attr("width", 5 )
      .attr("height", 5 )
      //.style("fill", function(d) { return heatColor(d.permits)} )
      //.style("fill", function(d) { return heatColorAsQuartiles(d.permits);} )
      .style("fill", function(d) {return colorForDensity(d.permits); }) 
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave);


// Data Model Prepared - Now we can build graphs 
    buildGraph ("div#container-A", titleA, "", xTimeScale, yLinearScale, xDomain, yDomain, gameCountSlices, false);
    buildGraph ("div#container-B", titleB, "", xTimeScale, yLinearScale, xDomain, yDomain, gameCountSlices);
    buildGraph ("div#container-C", titleC, "", xTimeScale, ySqrtScale, xDomain, yDomain, gameCountSlices);
    buildGraph ("div#container-D", titleD, "dbader7", xTimeScale, yLogScale, xDomain, yDomain, gameCountSlices);
};


// Three function that change the tooltip when user hover / move / leave a cell
var mouseover = function(d) {
    tooltip.style("opacity", 1)
    //mytip.style("opacity", 1)
}
var mousemove = function(d) {
    updateTooltip(d);
    // console.log("mouse position: ", d3.mouse(this));
    tooltip
      .html("Ward: " + d.WARD + "<br>Month: " + d.month + "<br>Permits: " + d.permits)
      .style("left", (d3.mouse(this)[0]+70) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
      //.attr("width", 150)
      //.attr("height", 100)
}
var mouseleave = function(d) {
    tooltip.style("opacity", 0)
    // mytip.style("opacity", 0)
}

var tooltip = d3.select("body").append("div")
      .style("font-size", "12px")
      .style("width","80px")
      .style("height","40px")
      .style("background","#C3B3E5")
      .style("background","white")
      .style("opacity","1")
      .style("position","absolute")
      //.style("visibility","hidden")
      .style("box-shadow","0px 0px 6px #7861A5")
      .style("padding","10px");

// create a tooltip
var tooltip_v0 = d3.select("#container-A")
      .append("div")
      .style("opacity", 0)
      .attr("class", "tooltip")
      .style("background-color", "white")
      .style("border", "solid")
      .style("border-width", "2px")
      .style("border-radius", "5px")
      .style("padding", "5px")


// TODO: implement better tooltip
var mytip = d3.tip().attr('class', 'd3-tip').offset([100, 100])
                .html(function(d) {return "<strong>Frequency:</strong> <span style='color:red'>Hello Cruel World</span>";});
svg.call(mytip);  

function updateTooltip(d) {
    let markup = "<table>"
      + "<tr><td>Ward:</td><td>" + d.WARD + "</td></tr>"
      + "<tr><td>Month:</td><td>" + d.month           + "</td></tr>"
      + "<tr><td># permits:</td><td>" + d.permits      + "</td></tr>"
      + "</table>";
    mytip.html(markup);
} 

</script>