<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Chicago Building Permits</title>
    <script type="text/javascript" src="./js/d3.v5.min.js"></script>
    <script type="text/javascript" src="./js/linecharts.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/linecharts.css">
    <style></style>
</head>
<body>
<div id="container-A" class="svg-container"></div>
<div id="container-B" class="svg-container"></div>
<div id="container-C" class="svg-container"></div>
<div id="container-D" class="svg-container"></div>
<div id="container-E" class="svg-container"></div>
<script>
//------------------------1. PREPARATION-------------------------//
//var colorScheme = d3.scaleOrdinal(d3.schemeCategory10);
var colorScheme = d3.scaleOrdinal(d3.schemeTableau10);

// useful functions
const timeConv = d3.timeParse("%Y-%m");
// function labelMaker (s) { return s.substring(0, s.indexOf("=count")); };
function labelMaker (s) {return ("Ward " + s); };

function onlyCounts (currentItem, index, arr) {
    let yesCounts = (index % 2) == 0;
    return yesCounts;
};

// ---------------------- Common Function -----------------------//
const width = 480;
const height = 250;
//----------------------------SCALES----------------------------//
const xTimeScale = d3.scaleTime().range([0,width]);
const yLinearScale = d3.scaleLinear().rangeRound([height, 0]);
const yLogScale = d3.scaleLog().rangeRound([height, 10]);
const ySqrtScale = d3.scaleSqrt().rangeRound([height, 0]);

const xScale = xTimeScale;
const yScale = yLogScale;

//-------------------------2. DRAWING---------------------------//

// --- splic --//
function buildGraph (divName, chartTitle, gtUserStamp, xScale, yScale, xDomain, yDomain, wards, animateMe=true) {
    //-----------------------------SVG--------------------------//
    //var margin = {top: 80, right: 20, bottom: 80, left: 50},
    //    width = 400 - margin.left - margin.right,
    //    height = 270 - margin.top â€“ margin.bottom;

    //const width = 960;
    //const height = 500;
    //const margin = 50;
    //const padding = 20;

    const width = 480;
    const height = 250;
    const margin = 25;
    const padding = 10;

    const adj = 100;

    //----------------------------LINES-----------------------------//

    // Experiment on interpolation
    const line = d3.line()
        .curve(d3.curveBasis)
        //.curve(d3.curveCatmullRomOpen)
        .x(function(d) { return xScale(d.month); })
        .y(function(d) { return yScale(d.permits); }); 

    let id = 0;
    const ids = function () {return "line-"+id++;}  

    //-----------------------------AXES-----------------------------//
    const yaxis = d3.axisLeft().ticks(10).scale(yScale);

    const xaxis = d3.axisBottom()
        .ticks(d3.timeYear.every(2))
        .tickFormat(d3.timeFormat('%b %Y'))
        .scale(xScale);

    xScale.domain(xDomain);
    yScale.domain(yDomain);

    // 0 works for Linear, Sqrt;  1 required for Log scale

    // we are appending SVG first
    const svg = d3.select(divName).append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "-"
              + adj + " -"
              + adj + " "
              + (width + adj*3) + " "
              + (height + adj*3))
        .style("padding", padding)
        .style("margin", margin)
        .classed("svg-content", true);

//-----------------------------AXES-----------------------------//
    svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xaxis);

    svg.append("g")
        .attr("class", "axis")
        .call(yaxis);

// Add the text label for Y axis
    let y_center = height/2;
    svg.append("text")
       .attr("id", "y_axis_label")
       .attr("x", -padding).attr("y", y_center * 1.5)
       .attr("font-size", "12px")
       //.attr("transform", "rotate(-90, -60, 250)")
       //.text("New Building Permits");
       .attr("transform", "rotate(-90, -60, " + y_center * 1.5 + ")")
       .text("New Building Permits");

    let x_center = width/2;
    svg.append("text")
       .attr("id", "x_axis_label")
       .attr("x", x_center).attr("y", height + 40)
       .attr("font-size", "12px")
       .text("Timeline");

//----------------------------LINES-----------------------------//
    const lines = svg.selectAll("lines")
        .data(wards)
        .enter()
        //.filter(function (d) {return d.id.endsWith("=count");})
        .append("g");

    path = lines.append("path")
        .attr("class", "line-0")
        .style("stroke", function(d, i) {return d3.schemeCategory10[i];})
        .attr("d", function(d) {return line(d.values);});


    if (animateMe) {
        // Animate it
        // inspired by https://bl.ocks.org/basilesimon/f164aec5758d16d51d248e41af5428e4
        var totalLength = path.node().getTotalLength();

        path.attr("stroke-dasharray", totalLength + " " + totalLength)
            .attr("stroke-dashoffset", totalLength)
            .transition()
              .duration(4000)
              .ease(d3.easeLinear)
              .attr("stroke-dashoffset", 0);
              // .on("end", repeat); 
    };

    // Graph Lines - labels
    lines.append("text")
        .attr("class","line_label")
        .datum(function(d) {return { id: d.id, value: d.values[d.values.length - 1]}; })
        .attr("transform", function(d, i) {
            console.log(i, d);
            return "translate(" + (xScale(xDomain[1]) + 10) + "," + (yScale(i * 3) - 10) + ")"; 
        })
        .attr("x", 5)
        .style("fill", function(d, i) {return d3.schemeCategory10[i];})
        .text(function(d) { return labelMaker(d.id); });

    // Title
    svg.append("text")
       .attr("id", "title")
       .text(chartTitle)
       .attr("x", x_center/2).attr("y", 0)
       .attr("font-size", "16px")

    addGtUserStamp(svg, width, height + 40, gtUserStamp);
    }; // buildGraph

//-----------------------------DATA------------------------------//

d3.dsv(",", "./new_permits_by_ward_month.csv").then( buildMyLineChart );

function buildMyLineChart (array_data) {


    // // Additional cleaning - enrich the data structure
    let wards = [];
    let line_data = [];
    let current_ward = 1;
    for (let i = 0; i < array_data.length; i++) {
        let row = array_data[i];
        let row_ward = +row.WARD
        if (row_ward == current_ward) {
            data_point = {month: timeConv(row.month), permits: +row.permits};
            line_data.push( data_point );
        }
        else /* new ward */ {
            let ward_data = {id: current_ward, values: line_data}
            wards.push( ward_data );
            
            current_ward = row_ward;
            line_data = [];
            data_point = {month: timeConv(row.month), permits: +row.permits};
            line_data.push( data_point );
        };
    };
    let ward_data = {id: current_ward, values: line_data}
    wards.push( ward_data );


    let xDomain = d3.extent(array_data, function(d){return timeConv(d.month)});

    // 0 works for Linear, Sqrt;  1 required for Log scale
    let yDomain = [(1), d3.max(wards, function(c) {
        return d3.max(c.values, function(d) {
            return d.permits + 4; });
            })
        ];
  

    let titleA = "New Building Permits by Ward (Wards 1 - 10)";
    let titleB = "New Building Permits by Ward (Wards 11 - 20)";
    let titleC = "New Building Permits by Ward (Wards 21 - 30)";
    let titleD = "New Building Permits by Ward (Wards 31 - 40)";
    let titleE = "New Building Permits by Ward (Wards 41 - 50)";

// Data Model Prepared - Now we can build graphs 
    buildGraph ("div#container-A", titleA, "", xTimeScale, yLinearScale, xDomain, yDomain, wards.slice(0,10), false);
    buildGraph ("div#container-B", titleB, "", xTimeScale, yLinearScale, xDomain, yDomain, wards.slice(10,20), true);
    buildGraph ("div#container-C", titleC, "", xTimeScale, yLinearScale, xDomain, yDomain, wards.slice(20,30), false);
    buildGraph ("div#container-D", titleD, "", xTimeScale, yLinearScale, xDomain, yDomain, wards.slice(30,40), false);
    buildGraph ("div#container-E", titleE, "", xTimeScale, yLinearScale, xDomain, yDomain, wards.slice(40,50), false);

}; /** buildMyLineChart **/

</script>